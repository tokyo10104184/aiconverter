<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TextMimic Studio - ä½œæˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', 'Noto Sans JP', sans-serif; } .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen pb-20">
    <div id="app" class="max-w-4xl mx-auto">
        <!-- åˆæœŸãƒ­ãƒ¼ãƒ‰ä¸­ -->
        <div v-if="!authInitialized" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
            <div class="loader border-indigo-200 border-t-indigo-600 w-12 h-12"></div>
        </div>

        <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-10 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">M</div>
                <span class="font-bold text-slate-900">TextMimic Studio</span>
            </div>
            <div class="flex gap-3 items-center">
                <div v-if="user" class="hidden md:flex items-center gap-2 mr-2">
                   <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden">
                       <img v-if="user.photoURL" :src="user.photoURL" class="w-full h-full object-cover">
                       <div v-else class="w-full h-full flex items-center justify-center text-slate-500 font-bold text-xs">{{ user.email?.charAt(0).toUpperCase() }}</div>
                   </div>
                   <button @click="logout" class="text-xs text-slate-500 hover:text-red-500 underline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>

                <a href="index.html" class="text-sm font-bold text-slate-500 hover:text-slate-800 flex items-center">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
                <button @click="publishMaker" :disabled="isPublishing" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold px-4 py-2 rounded-lg transition shadow-md flex items-center gap-2">
                    <span v-if="isPublishing" class="loader w-4 h-4 border-2"></span>
                    <span v-else>å…¬é–‹ã™ã‚‹ ğŸš€</span>
                </button>
            </div>
        </header>

        <main class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8 relative">
            <!-- ãƒ–ãƒ­ãƒƒã‚¯ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆ) -->
            <div v-if="!user && authInitialized" class="absolute inset-0 z-40 bg-slate-100/90 backdrop-blur-sm flex items-start justify-center pt-20">
                <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 border border-slate-200">
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4">M</div>
                        <h2 class="text-2xl font-extrabold text-slate-900">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
                        <p class="text-slate-500 mt-2 text-sm">ä½œæˆæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚</p>
                    </div>

                    <div class="space-y-4">
                        <button @click="loginWithGoogle" class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 shadow-sm">
                            <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                        </button>

                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-slate-200"></div>
                            <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-bold">OR</span>
                            <div class="flex-grow border-t border-slate-200"></div>
                        </div>

                        <!-- Email Login Form -->
                        <form @submit.prevent="handleEmailAuth" class="space-y-3">
                            <div>
                                <input v-model="email" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="w-full p-3 border border-slate-300 rounded-xl bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none transition" required>
                            </div>
                            <div>
                                <input v-model="password" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full p-3 border border-slate-300 rounded-xl bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none transition" required minlength="6">
                            </div>

                            <button type="submit" :disabled="authLoading" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl transition shadow flex justify-center items-center">
                                <span v-if="authLoading" class="loader w-4 h-4 border-2"></span>
                                <span v-else>{{ authMode === 'login' ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²' }}</span>
                            </button>
                        </form>

                        <div v-if="authError" class="text-red-500 text-xs text-center font-bold bg-red-50 p-2 rounded-lg">
                            {{ authError }}
                        </div>

                        <div class="text-center">
                            <button @click="toggleAuthMode" class="text-indigo-600 text-xs font-bold hover:underline">
                                {{ authMode === 'login' ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ç™»éŒ²' : 'ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ãƒ­ã‚°ã‚¤ãƒ³' }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å·¦å´ï¼šè¨­å®š -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold mb-4">ğŸ›  åŸºæœ¬è¨­å®š</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ã‚¢ã‚¤ã‚³ãƒ³ (Emoji)</label>
                            <input v-model="form.emoji" type="text" class="text-3xl w-16 h-16 text-center border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ãƒ¡ãƒ¼ã‚«ãƒ¼å</label>
                            <input v-model="form.title" type="text" class="w-full p-3 border border-slate-300 rounded-xl font-bold" placeholder="ä¾‹ï¼šé–¢è¥¿å¼ãŠã‹ã‚“ãƒ¡ãƒ¼ã‚«ãƒ¼">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">èª¬æ˜æ–‡</label>
                            <input v-model="form.description" type="text" class="w-full p-3 border border-slate-300 rounded-xl" placeholder="çŸ­ã„èª¬æ˜...">
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 ring-2 ring-indigo-50">
                    <h2 class="text-lg font-bold mb-2 text-indigo-700">ğŸ§  AIã¸ã®æŒ‡ç¤º (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)</h2>
                    <textarea v-model="form.systemPrompt" class="w-full h-40 p-4 border border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-500 resize-none bg-indigo-50/30 text-sm" placeholder="ä¾‹ï¼šã‚ãªãŸã¯ã€‡ã€‡ã§ã™ã€‚å…¥åŠ›ã•ã‚ŒãŸæ–‡ç« ã‚’ã€‡ã€‡ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚"></textarea>
                </div>
            </div>

            <!-- å³å´ï¼šãƒ†ã‚¹ãƒˆ -->
            <div class="space-y-6">
                <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-xl">
                    <h2 class="text-lg font-bold mb-4">ğŸ§ª å‹•ä½œãƒ†ã‚¹ãƒˆ</h2>
                    <input v-model="testInput" type="text" class="w-full p-3 bg-slate-700 border border-slate-600 rounded-xl text-white mb-2" placeholder="ãƒ†ã‚¹ãƒˆç”¨ãƒ†ã‚­ã‚¹ãƒˆ...">
                    <button @click="runTest" :disabled="!testInput || isLoading" class="w-full bg-indigo-500 hover:bg-indigo-400 text-white font-bold py-3 rounded-xl transition flex justify-center items-center gap-2">
                        <span v-if="isLoading" class="loader"></span>
                        <span v-if="!isLoading">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â–¶</span>
                    </button>
                    <div v-if="testResult" class="mt-6 pt-6 border-t border-slate-700 bg-slate-900 p-4 rounded-xl whitespace-pre-wrap">{{ testResult }}</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { OPENROUTER_API_KEY, firebaseConfig } from './config.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    form: { emoji: 'ğŸ¯', title: '', description: '', systemPrompt: '' },
                    testInput: '', testResult: '', isLoading: false, isPublishing: false,
                    // Auth State
                    user: null,
                    authInitialized: false,
                    authMode: 'login', // 'login' or 'register'
                    email: '',
                    password: '',
                    authError: '',
                    authLoading: false
                }
            },
            mounted() {
                onAuthStateChanged(auth, (user) => {
                    this.user = user;
                    this.authInitialized = true;
                });
            },
            methods: {
                async runTest() {
                    if (!this.testInput) return;
                    this.isLoading = true;
                    this.testResult = '';
                    try {
                        if (!OPENROUTER_API_KEY) {
                            await new Promise(r => setTimeout(r, 1000));
                            this.testResult = "ã€ãƒ‡ãƒ¢ã€‘APIã‚­ãƒ¼æœªè¨­å®š"; this.isLoading = false; return; 
                        }
                        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                                'HTTP-Referer': window.location.href, // OpenRouter requirement
                                'X-Title': 'TextMimic' // OpenRouter requirement
                            },
                            body: JSON.stringify({
                                model: "tngtech/deepseek-r1t2-chimera:free",
                                messages: [ { role: "system", content: this.form.systemPrompt }, { role: "user", content: this.testInput } ],
                                temperature: 0.7
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status} ${response.statusText}`);
                        }

                        const data = await response.json();
                        if (!data.choices || !data.choices.length || !data.choices[0].message) {
                            console.error('Unexpected API response:', data);
                            throw new Error('APIã‹ã‚‰ã®å¿œç­”å½¢å¼ãŒäºˆæœŸã—ãªã„ã‚‚ã®ã§ã—ãŸã€‚');
                        }
                        this.testResult = data.choices[0].message.content;
                    } catch (error) { alert("Error: " + error.message); } finally { this.isLoading = false; }
                },
                async publishMaker() {
                    if (!this.user) {
                        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                        return;
                    }
                    if(!this.form.title || !this.form.systemPrompt) { alert("ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯å¿…é ˆã§ã™"); return; }
                    this.isPublishing = true;
                    try {
                        // Firestoreã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        await addDoc(collection(db, "makers"), {
                            ...this.form,
                            createdAt: serverTimestamp(), // ä½œæˆæ—¥æ™‚
                            authorId: this.user.uid,
                            authorName: this.user.displayName || this.user.email || 'Anonymous'
                        });
                        alert("å…¬é–‹ã—ã¾ã—ãŸï¼ğŸ‰ ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚");
                        window.location.href = "index.html"; // ãƒ›ãƒ¼ãƒ ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    } catch (error) {
                        alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + error.message);
                        console.error(error);
                    } finally {
                        this.isPublishing = false;
                    }
                },
                // Auth Methods
                toggleAuthMode() {
                    this.authMode = this.authMode === 'login' ? 'register' : 'login';
                    this.authError = '';
                },
                async loginWithGoogle() {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                        // Auth state change will handle the rest
                    } catch (error) {
                        console.error(error);
                        this.authError = "Googleãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message;
                    }
                },
                async handleEmailAuth() {
                    this.authLoading = true;
                    this.authError = '';
                    try {
                        if (this.authMode === 'login') {
                            await signInWithEmailAndPassword(auth, this.email, this.password);
                        } else {
                            await createUserWithEmailAndPassword(auth, this.email, this.password);
                        }
                    } catch (error) {
                        console.error(error);
                        let msg = error.code;
                        if(error.code === 'auth/email-already-in-use') msg = 'ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚';
                        else if(error.code === 'auth/wrong-password') msg = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚';
                        else if(error.code === 'auth/user-not-found') msg = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
                        else if(error.code === 'auth/weak-password') msg = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ï¼ˆ6æ–‡å­—ä»¥ä¸Šå¿…è¦ï¼‰ã€‚';
                        else if(error.code === 'auth/invalid-email') msg = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                        this.authError = msg;
                    } finally {
                        this.authLoading = false;
                    }
                },
                async logout() {
                    try {
                        await signOut(auth);
                        // Block modal will reappear
                    } catch (error) {
                        alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—: " + error.message);
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
